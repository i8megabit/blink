<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SEO Link Recommender</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
  <div id="app"></div>
  <script type="text/babel">
    function App() {
      const [text, setText] = React.useState('');
      const [domain, setDomain] = React.useState('');
      const [links, setLinks] = React.useState([]);
      const [history, setHistory] = React.useState([]);
      const [error, setError] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [wpLoading, setWpLoading] = React.useState(false);
      const [progress, setProgress] = React.useState(0);
      const [progressText, setProgressText] = React.useState('');
      const [notifications, setNotifications] = React.useState([]);
      const [currentStep, setCurrentStep] = React.useState('');
      const [totalSteps, setTotalSteps] = React.useState(0);
      const [completedSteps, setCompletedSteps] = React.useState(0);

      React.useEffect(() => { 
        console.log('üöÄ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç App –∑–∞–≥—Ä—É–∂–µ–Ω');
        addNotification('success', '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
        loadHistory(); 
      }, []);

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      function addNotification(type, message, details = null) {
        const notification = {
          id: Date.now(),
          type, // 'success', 'error', 'info', 'warning'
          message,
          details,
          timestamp: new Date().toLocaleTimeString()
        };
        console.log(`üîî [${type.toUpperCase()}] ${message}`, details || '');
        setNotifications(prev => [notification, ...prev.slice(0, 4)]); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5
        
        // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è success –∏ info
        if (type === 'success' || type === 'info') {
          setTimeout(() => {
            setNotifications(prev => prev.filter(n => n.id !== notification.id));
          }, 5000);
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      function updateProgress(step, completed, total, message) {
        setCurrentStep(step);
        setCompletedSteps(completed);
        setTotalSteps(total);
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        setProgress(percentage);
        setProgressText(message);
        console.log(`üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: ${completed}/${total} (${percentage}%) - ${step}: ${message}`);
      }

      async function loadHistory() {
        try {
          console.log('üì• –ó–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é...');
          addNotification('info', '–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...');
          
          const resp = await fetch('http://localhost:8000/api/v1/recommendations');
          console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–∏—Å—Ç–æ—Ä–∏—è):', resp.status, resp.statusText, resp.headers);
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          const data = await resp.json();
          console.log('üì• –î–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏:', data);
          console.log('üìä –ë–î: –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', data.length);
          
          setHistory(data);
          addNotification('success', `–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${data.length} –∑–∞–ø–∏—Å–µ–π`);
        } catch (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err);
          addNotification('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏', err.message);
          setError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${err.message}`);
        }
      }

      async function sendText() {
        if (!text.trim()) { 
          setError('–ü–æ–ª–µ —Ç–µ–∫—Å—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'); 
          return; 
        }
        
        setError('');
        setLoading(true);
        setProgress(0);
        setProgressText('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...');
        
        try {
          console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ–∫—Å—Ç:', text.substring(0, 100) + '...');
          
          setProgress(25);
          setProgressText('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑...');
          
          const resp = await fetch('http://localhost:8000/api/v1/recommend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
          });
          
          console.log('üì§ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–µ–∫—Å—Ç):', resp.status, resp.statusText);
          
          setProgress(50);
          setProgressText('–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞...');
          
          if (!resp.ok) {
            const errorText = await resp.text();
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
            throw new Error(`HTTP ${resp.status}: ${errorText}`);
          }
          
          setProgress(75);
          setProgressText('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...');
          
          const data = await resp.json();
          console.log('üì§ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏:', data);
          
          setLinks(data.links.map(l => ({ from: '', to: l, anchor: l })));
          
          setProgress(90);
          setProgressText('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏...');
          
          await loadHistory();
          
          setProgress(100);
          setProgressText('–ì–æ—Ç–æ–≤–æ!');
          
          console.log('‚úÖ –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω');
        } catch (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞:', err);
          setError(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞: ${err.message}`);
        } finally {
          setTimeout(() => {
            setLoading(false);
            setProgress(0);
            setProgressText('');
          }, 1000);
        }
      }

      async function sendDomain() {
        if (!domain.trim()) { 
          addNotification('warning', '–ü–æ–ª–µ –¥–æ–º–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
          setError('–ü–æ–ª–µ –¥–æ–º–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'); 
          return; 
        }
        
        setError('');
        setWpLoading(true);
        updateProgress('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', 0, 5, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ WordPress...');
        addNotification('info', `–ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ —Å–∞–π—Ç–∞: ${domain}`);
        
        try {
          console.log('üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é WordPress —Å–∞–π—Ç:', domain);
          console.log('üåê –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å:', {
            url: 'http://localhost:8000/api/v1/wp_recommend',
            method: 'POST',
            domain: domain,
            timestamp: new Date().toISOString()
          });
          
          updateProgress('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ', 1, 5, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WordPress API...');
          
          const startTime = performance.now();
          const resp = await fetch('http://localhost:8000/api/v1/wp_recommend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain })
          });
          const requestTime = performance.now() - startTime;
          
          console.log('üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (WordPress):', {
            status: resp.status,
            statusText: resp.statusText,
            headers: Object.fromEntries(resp.headers.entries()),
            requestTime: `${Math.round(requestTime)}ms`
          });
          
          updateProgress('–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö', 2, 5, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞...');
          
          if (!resp.ok) {
            const errorText = await resp.text();
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
            console.error('üìä –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
              status: resp.status,
              statusText: resp.statusText,
              body: errorText,
              url: resp.url
            });
            addNotification('error', `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${resp.status}`, errorText);
            throw new Error(`HTTP ${resp.status}: ${errorText}`);
          }
          
          updateProgress('–ü–∞—Ä—Å–∏–Ω–≥', 3, 5, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
          
          const data = await resp.json();
                     console.log('üîç –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ WordPress:', data);
           console.log('üìä Ollama –æ—Ç–≤–µ—Ç:', {
             recommendationsCount: (data.recommendations && data.recommendations.length) || 0,
             firstRecommendation: (data.recommendations && data.recommendations[0]) || null,
             totalRequestTime: `${Math.round(performance.now() - startTime)}ms`
           });
          
          updateProgress('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI', 4, 5, '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...');
          
                     setLinks(data.recommendations || []);
           addNotification('success', `–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω: ${(data.recommendations && data.recommendations.length) || 0} —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π`);
          
          updateProgress('–ó–∞–≤–µ—Ä—à–µ–Ω–æ', 5, 5, '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!');
          
          console.log('‚úÖ WordPress —Å–∞–π—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ WordPress:', err);
          console.error('üìä –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
            name: err.name,
            message: err.message,
            stack: err.stack
          });
          addNotification('error', '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ WordPress', err.message);
          setError(`–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ WordPress: ${err.message}`);
        } finally {
          setTimeout(() => {
            setWpLoading(false);
            setProgress(0);
            setProgressText('');
            setCurrentStep('');
            setTotalSteps(0);
            setCompletedSteps(0);
          }, 2000);
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —á–∏—Å—Ç–æ–≥–æ URL –∏–∑ —Å—Ç—Ä–æ–∫–∏
      function extractUrl(urlString) {
        if (!urlString) return '';
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã —Ç–∏–ø–∞ "1. ", "2. " –∏ —Ç.–¥.
        const cleanUrl = urlString.replace(/^\d+\.\s*/, '');
        return cleanUrl;
      }

      return (
        <section className="section">
          <div className="container">
            <h1 className="title has-text-centered">SEO Link Recommender</h1>
            
            <div className="box">
              <div className="field">
                <label className="label">–¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
                <div className="control">
                  <textarea 
                    className="textarea" 
                    rows="4" 
                    value={text} 
                    onChange={e => setText(e.target.value)}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å—Å—ã–ª–æ–∫..."
                  ></textarea>
                </div>
                <button 
                  className={`button is-link mt-2 ${loading ? 'is-loading' : ''}`}
                  onClick={sendText}
                  disabled={loading || wpLoading}
                >
                  {loading ? '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...' : '–ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏'}
                </button>
              </div>
              
              <div className="field mt-4">
                <label className="label">WordPress —Å–∞–π—Ç</label>
                <div className="control">
                  <input 
                    className="input" 
                    placeholder="example.com" 
                    value={domain} 
                    onChange={e => setDomain(e.target.value)} 
                  />
                </div>
                <button 
                  className={`button is-primary mt-2 ${wpLoading ? 'is-loading' : ''}`}
                  onClick={sendDomain}
                  disabled={loading || wpLoading}
                >
                  {wpLoading ? '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...' : '–ê–Ω–∞–ª–∏–∑ WordPress'}
                </button>
              </div>
              
              {/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */}
              {(loading || wpLoading) && (
                <div className="mt-4">
                  <div className="field">
                    <label className="label is-small">
                      {currentStep && totalSteps > 0 ? 
                        `${currentStep} (${completedSteps}/${totalSteps})` : 
                        progressText
                      }
                    </label>
                    <progress className="progress is-primary" value={progress} max="100">
                      {progress}%
                    </progress>
                    <p className="help has-text-centered">
                      {progress}% - {progressText}
                    </p>
                  </div>
                </div>
              )}
              
              {/* –ü–∞–Ω–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */}
              {notifications.length > 0 && (
                <div className="mt-4">
                  <div className="field">
                    <label className="label is-small">
                      üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ({notifications.length})
                    </label>
                    <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                      {notifications.map(notification => (
                        <div 
                          key={notification.id} 
                          className={`notification is-small mt-1 ${
                            notification.type === 'success' ? 'is-success' :
                            notification.type === 'error' ? 'is-danger' :
                            notification.type === 'warning' ? 'is-warning' :
                            'is-info'
                          }`}
                        >
                          <button 
                            className="delete is-small" 
                            onClick={() => setNotifications(prev => prev.filter(n => n.id !== notification.id))}
                          ></button>
                          <div className="is-size-7">
                            <strong>[{notification.timestamp}]</strong> {notification.message}
                            {notification.details && (
                              <div className="mt-1 has-text-grey">
                                <small>{notification.details}</small>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
              
              {error && (
                <div className="notification is-danger mt-3">
                  <button className="delete" onClick={() => setError('')}></button>
                  {error}
                </div>
              )}
            </div>
            
            <div className="content">
              <h2>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
              {links.length === 0 ? (
                <p className="has-text-grey">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ WordPress —Å–∞–π—Ç–∞</p>
              ) : (
                <table className="table is-striped is-fullwidth">
                  <thead>
                    <tr><th>–û—Ç–∫—É–¥–∞</th><th>–ö—É–¥–∞</th><th>–ê–Ω–∫–æ—Ä</th></tr>
                  </thead>
                  <tbody>
                    {links.map((l, i) => (
                      <tr key={i}>
                        <td>
                          {l.from ? (
                            <a href={extractUrl(l.from)} target="_blank" rel="noopener">
                              {extractUrl(l.from)}
                            </a>
                          ) : '‚Äî'}
                        </td>
                        <td>
                          {l.to ? (
                            <a href={extractUrl(l.to)} target="_blank" rel="noopener">
                              {extractUrl(l.to)}
                            </a>
                          ) : '‚Äî'}
                        </td>
                        <td>{l.anchor || '‚Äî'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
            
            <div className="content">
              <h2>–ò—Å—Ç–æ—Ä–∏—è ({history.length})</h2>
              {history.length === 0 ? (
                <p className="has-text-grey">–ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –∑–¥–µ—Å—å</p>
              ) : (
                <ul>
                  {history.map(h => (
                    <li key={h.id} className="mb-2">
                      <strong>{h.text.substring(0, 80)}...</strong><br/>
                      <small className="has-text-grey">
                        –°—Å—ã–ª–∫–∏: {(h.links || []).join(', ')}
                      </small>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>
        </section>
      );
    }

    console.log('üéØ –ó–∞–ø—É—Å–∫–∞—é React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
    ReactDOM.createRoot(document.getElementById('app')).render(<App />);
  </script>
</body>
</html>
