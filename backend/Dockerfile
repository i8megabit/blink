# syntax=docker/dockerfile:1.4

# ========================================
# üöÄ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô DOCKERFILE –î–õ–Ø BACKEND
# ========================================
# 
# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
# - BuildKit —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
# - Multi-stage —Å–±–æ—Ä–∫–∞
# - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (non-root user)
# - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞
# - Health checks
# - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
# - –ü–µ—Ä–µ–∫–æ–º–ø–∏–ª—è—Ü–∏—è Python —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π SQLite

# –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
FROM python:3.11.9-slim-bullseye as base

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑–∞
LABEL maintainer="reLink Team <i8megabit@gmail.com>" \
      description="SEO Link Recommender Backend Service" \
      version="4.1.2" \
      org.opencontainers.image.source="https://github.com/eberil/relink" \
      org.opencontainers.image.licenses="MIT"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    libpq-dev \
    libffi-dev \
    libssl-dev \
    pkg-config \
    wget \
    zlib1g-dev \
    libreadline-dev \
    libncursesw5-dev \
    libbz2-dev \
    libsqlite3-dev \
    libgdbm-compat-dev \
    liblzma-dev \
    tk-dev \
    uuid-dev \
    && rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ SQLite –¥–ª—è ChromaDB
RUN wget https://www.sqlite.org/2024/sqlite-autoconf-3450100.tar.gz \
    && tar -xzf sqlite-autoconf-3450100.tar.gz \
    && cd sqlite-autoconf-3450100 \
    && ./configure --prefix=/usr/local \
    && make \
    && make install \
    && cd .. \
    && rm -rf sqlite-autoconf-3450100*

# –ü–µ—Ä–µ–∫–æ–º–ø–∏–ª—è—Ü–∏—è Python —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π SQLite
RUN wget https://www.python.org/ftp/python/3.11.9/Python-3.11.9.tgz \
    && tar -xzf Python-3.11.9.tgz \
    && cd Python-3.11.9 \
    && ./configure --prefix=/usr/local \
        --enable-optimizations \
        --with-ensurepip=install \
        --with-system-ffi \
        --with-system-expat \
        --enable-loadable-sqlite-extensions \
        LDFLAGS="-L/usr/local/lib" \
        CPPFLAGS="-I/usr/local/include" \
    && make -j$(nproc) \
    && make install \
    && cd .. \
    && rm -rf Python-3.11.9*

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN groupadd -r appuser && useradd -r -g appuser appuser

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .

# –≠—Ç–∞–ø 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
FROM base as dependencies

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN pip install --no-cache-dir --upgrade pip setuptools wheel
RUN pip install --no-cache-dir -r requirements.txt

# –≠—Ç–∞–ø 3: –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
FROM base as builder

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
COPY --from=dependencies /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
COPY . .

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è Python —Ñ–∞–π–ª–æ–≤
RUN python -m compileall .

# –≠—Ç–∞–ø 4: –ü—Ä–æ–¥–∞–∫—à–Ω –æ–±—Ä–∞–∑
FROM debian:bullseye-slim as production

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
LABEL maintainer="reLink Team <i8megabit@gmail.com>" \
      description="SEO Link Recommender Backend Service" \
      version="4.1.2"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    libpq5 \
    libffi7 \
    libssl1.1 \
    libreadline8 \
    libncursesw6 \
    libbz2-1.0 \
    libgdbm-compat4 \
    liblzma5 \
    libuuid1 \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Python –∏ SQLite –∏–∑ base
COPY --from=base /usr/local/bin/python* /usr/local/bin/
COPY --from=base /usr/local/lib/python3.11 /usr/local/lib/python3.11
COPY --from=base /usr/local/lib/libpython3.11* /usr/local/lib/
COPY --from=base /usr/local/include/python3.11 /usr/local/include/python3.11
COPY --from=base /usr/local/bin/sqlite3 /usr/local/bin/sqlite3
COPY --from=base /usr/local/lib/libsqlite3.so* /usr/local/lib/

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV PATH="/usr/local/bin:$PATH"
ENV LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
ENV PYTHONPATH="/usr/local/lib/python3.11/site-packages"

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN groupadd -r appuser && useradd -r -g appuser appuser

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
COPY --from=builder /app /app

# –°–º–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤
RUN chown -R appuser:appuser /app

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
USER appuser

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# –≠–∫—Å–ø–æ—Ä—Ç –ø–æ—Ä—Ç–∞
EXPOSE 8000

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
