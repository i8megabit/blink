<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SEO Link Recommender</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.css" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <style>
    :root {
      --apple-blue: #007AFF;
      --apple-blue-light: #5AC8FA;
      --apple-green: #34C759;
      --apple-orange: #FF9500;
      --apple-red: #FF3B30;
      --apple-gray: #4A4A4A;
      --apple-gray-light: #F2F2F7;
      --apple-gray-dark: #1C1C1E;
      --apple-black: #000000;
      --apple-white: #FFFFFF;
      --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.08);
      --shadow-heavy: 0 8px 32px rgba(0, 0, 0, 0.12);
      --blur-glass: blur(20px);
      --border-radius: 12px;
      --border-radius-large: 20px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      box-sizing: border-box;
    }

    body, html {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .apple-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: var(--blur-glass);
      -webkit-backdrop-filter: var(--blur-glass);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
    }

         .hero-apple {
       background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
       color: var(--apple-white);
       padding: 20px 0;
       position: relative;
       overflow: hidden;
     }

    .hero-apple::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

         .hero-title {
       font-size: clamp(1.5rem, 3vw, 2.2rem);
       font-weight: 700;
       text-align: center;
       margin-bottom: 0.3rem;
       background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
       -webkit-background-clip: text;
       -webkit-text-fill-color: transparent;
       background-clip: text;
       letter-spacing: -0.02em;
     }

         .hero-subtitle {
       font-size: 1rem;
       font-weight: 400;
       text-align: center;
       opacity: 0.8;
       max-width: 450px;
       margin: 0 auto;
     }

         .nav-apple {
       padding: 15px 0;
       background: rgba(255, 255, 255, 0.95);
       backdrop-filter: var(--blur-glass);
       position: sticky;
       top: 0;
       z-index: 1000;
       border-bottom: 1px solid rgba(0, 0, 0, 0.05);
     }

    .nav-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .btn-apple {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius);
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn-apple::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-apple:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: var(--apple-blue);
      color: var(--apple-white);
      box-shadow: var(--shadow-light);
    }

    .btn-primary:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .btn-secondary {
      background: var(--apple-gray-light);
      color: var(--apple-gray-dark);
    }

    .btn-secondary:hover {
      background: #e5e5ea;
      transform: translateY(-1px);
    }

    .btn-large {
      padding: 16px 32px;
      font-size: 16px;
      border-radius: var(--border-radius-large);
    }

         .step-card {
       background: var(--apple-white);
       border-radius: var(--border-radius-large);
       box-shadow: var(--shadow-medium);
       padding: 30px;
       margin: 20px 0;
       transition: var(--transition);
       border: 2px solid transparent;
       position: relative;
       overflow: hidden;
     }

    .step-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--apple-blue), var(--apple-blue-light));
      opacity: 0;
      transition: var(--transition);
    }

    .step-card.active {
      border-color: var(--apple-blue);
      transform: translateY(-4px);
      box-shadow: var(--shadow-heavy);
    }

    .step-card.active::before {
      opacity: 1;
    }

    .step-card.completed {
      border-color: var(--apple-green);
      background: linear-gradient(135deg, #f0fff4 0%, #f8fff8 100%);
    }

    .input-apple {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e5e5ea;
      border-radius: var(--border-radius);
      font-family: inherit;
      font-size: 16px;
      background: var(--apple-white);
      transition: var(--transition);
      outline: none;
    }

    .input-apple:focus {
      border-color: var(--apple-blue);
      box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    .input-large {
      padding: 20px 24px;
      font-size: 18px;
    }

    .analysis-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: var(--blur-glass);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .analysis-window {
      background: var(--apple-white);
      border-radius: var(--border-radius-large);
      padding: 40px;
      max-width: 900px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      will-change: transform, opacity;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .progress-apple {
      height: 8px;
      background: var(--apple-gray-light);
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--apple-blue), var(--apple-blue-light));
      border-radius: 4px;
      transition: width 0.3s ease-out, background 0.4s ease;
      animation: shimmer 2.5s ease-in-out infinite;
      will-change: width;
      position: relative;
      overflow: hidden;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    .progress-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: progressShine 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(0, 122, 255, 0.3);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 30px rgba(0, 122, 255, 0.5);
        transform: scale(1.001);
      }
    }

    @keyframes progressShine {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }

    @keyframes gentleUpdate {
      0% { 
        transform: scale(1);
        filter: brightness(1);
      }
      50% { 
        transform: scale(1.01);
        filter: brightness(1.1);
      }
      100% { 
        transform: scale(1);
        filter: brightness(1);
      }
    }

    .stats-card {
      background: linear-gradient(135deg, var(--apple-blue) 0%, var(--apple-blue-light) 100%);
      color: var(--apple-white);
      border-radius: var(--border-radius-large);
      padding: 30px;
      margin: 20px 0;
      box-shadow: var(--shadow-medium);
      transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
      will-change: background, transform;
      transform-origin: center;
    }

    .stats-card.smooth-update {
      animation: gentleUpdate 0.4s ease-out;
    }

    .log-container {
      background: var(--apple-gray-light);
      border-radius: var(--border-radius);
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      margin: 20px 0;
    }

    .log-entry {
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 8px;
      border-left: 4px solid;
      font-family: 'SF Mono', Consolas, Monaco, monospace;
      font-size: 14px;
      animation: slideInLeft 0.3s ease-out;
      background: var(--apple-white);
      box-shadow: var(--shadow-light);
      transition: all 0.2s ease;
      will-change: transform, opacity;
    }
    
    .log-entry:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-medium);
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .log-info { border-left-color: var(--apple-blue); }
    .log-success { border-left-color: var(--apple-green); }
    .log-warning { border-left-color: var(--apple-orange); }
    .log-error { border-left-color: var(--apple-red); }

    .icon-apple {
      width: 20px;
      height: 20px;
      stroke-width: 2;
    }

    /* Боковое меню */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: var(--blur-glass);
      border-right: 1px solid rgba(0, 0, 0, 0.05);
      padding: 20px;
      z-index: 1000;
      overflow-y: auto;
    }

    .main-content {
      margin-left: 280px;
      min-height: 100vh;
    }

    .sidebar-header {
      margin-bottom: 30px;
      text-align: center;
    }

    .sidebar-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--apple-black);
      margin-bottom: 0.5rem;
    }

    .sidebar-subtitle {
      font-size: 0.9rem;
      color: var(--apple-gray);
      margin-bottom: 0;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-menu-item {
      margin-bottom: 8px;
    }

    .sidebar-menu-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      text-decoration: none;
      color: var(--apple-gray-dark);
      transition: var(--transition);
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
      font-size: 14px;
    }

    .sidebar-menu-link:hover {
      background: var(--apple-gray-light);
      color: var(--apple-black);
    }

    .sidebar-menu-link.active {
      background: var(--apple-blue);
      color: var(--apple-white);
    }

    .sidebar-menu-link.active:hover {
      background: #0056b3;
    }

    .sidebar-badge {
      background: rgba(0, 0, 0, 0.1);
      color: inherit;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: auto;
    }

    .sidebar-menu-link.active .sidebar-badge {
      background: rgba(255, 255, 255, 0.2);
    }

    .card-apple {
      background: var(--apple-white);
      border-radius: var(--border-radius-large);
      box-shadow: var(--shadow-medium);
      transition: var(--transition);
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card-apple:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-heavy);
    }

    .table-apple {
      width: 100%;
      background: var(--apple-white);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow-light);
    }

    .table-apple th {
      background: var(--apple-gray-light);
      padding: 16px;
      font-weight: 600;
      text-align: left;
      border-bottom: 1px solid #e5e5ea;
    }

    .table-apple td {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .table-apple tr:hover {
      background: rgba(0, 122, 255, 0.02);
    }

    .tag-apple {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: var(--apple-gray-light);
      color: var(--apple-gray-dark);
    }

    .tag-success {
      background: rgba(52, 199, 89, 0.1);
      color: var(--apple-green);
    }

    .tag-warning {
      background: rgba(255, 149, 0, 0.1);
      color: var(--apple-orange);
    }

    .tag-danger {
      background: rgba(255, 59, 48, 0.1);
      color: var(--apple-red);
    }

    .notification-apple {
      padding: 16px 20px;
      border-radius: var(--border-radius);
      margin: 16px 0;
      background: var(--apple-white);
      border-left: 4px solid;
      box-shadow: var(--shadow-light);
    }

    .notification-success {
      border-left-color: var(--apple-green);
      background: rgba(52, 199, 89, 0.05);
    }

    .notification-warning {
      border-left-color: var(--apple-orange);
      background: rgba(255, 149, 0, 0.05);
    }

    .notification-error {
      border-left-color: var(--apple-red);
      background: rgba(255, 59, 48, 0.05);
    }

    .text-center { text-align: center; }
         .text-muted { color: #3A3A3A; font-weight: 500; }
    .font-weight-bold { font-weight: 600; }
    .font-weight-semibold { font-weight: 500; }

    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 16px; }
    .mt-4 { margin-top: 24px; }
    .mt-5 { margin-top: 32px; }
    .mb-2 { margin-bottom: 8px; }
    .mb-3 { margin-bottom: 16px; }
    .mb-4 { margin-bottom: 24px; }
    .mb-5 { margin-bottom: 32px; }

    .d-flex { display: flex; }
    .align-items-center { align-items: center; }
    .justify-content-between { justify-content: space-between; }
    .justify-content-center { justify-content: center; }
    .gap-2 { gap: 8px; }
    .gap-3 { gap: 16px; }

         /* Responsive */
     @media (max-width: 768px) {
       .apple-container { padding: 0 16px; }
       .step-card { padding: 24px; margin: 20px 0; }
       .analysis-window { padding: 24px; }
       .hero-apple { padding: 15px 0; }
       .nav-apple { padding: 10px 0; }
       .nav-buttons { flex-wrap: wrap; }
     }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .step-card {
        background: #1c1c1e;
        color: var(--apple-white);
      }
      .log-entry {
        background: #2c2c2e;
        color: var(--apple-white);
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="text/babel">
    function App() {
      const [domain, setDomain] = React.useState('');
      const [error, setError] = React.useState('');
      const [currentView, setCurrentView] = React.useState('domains');
      const [domains, setDomains] = React.useState([]);
      const [analysisHistory, setAnalysisHistory] = React.useState([]);
      const [selectedDomain, setSelectedDomain] = React.useState(null);
      const [showRecommendations, setShowRecommendations] = React.useState(false);
      
      // Real-time analysis states
      const [analysisLogs, setAnalysisLogs] = React.useState([]);
      const [analysisStats, setAnalysisStats] = React.useState(null);
      
      // Используем useDeferredValue для плавного прогресса без скачков скролла
      const deferredAnalysisStats = React.useDeferredValue(analysisStats);
      const isProgressStale = analysisStats !== deferredAnalysisStats;
      
      const [websocket, setWebsocket] = React.useState(null);
      const [clientId, setClientId] = React.useState(null);
      const [connectionStatus, setConnectionStatus] = React.useState('disconnected');
      
      // Оптимистичные ответы Ollama для мгновенного UI
      const [ollamaResponses, setOllamaResponses] = React.useState([]);
      const [optimisticOllamaResponses, addOptimisticOllamaResponse] = React.useOptimistic(
        ollamaResponses,
        (state, newResponse) => [...state, { ...newResponse, pending: true }]
      );
      
      // Refs только для критических DOM операций
      const progressBarRef = React.useRef(null);
      const progressTextRef = React.useRef(null);
      const progressDetailsRef = React.useRef(null);
      const [currentAnalysisId, setCurrentAnalysisId] = React.useState(null);
      const [recommendations, setRecommendations] = React.useState([]);
      
      // Новые состояния для уведомлений и стабильности
      const [notifications, setNotifications] = React.useState([]);
      const [analysisError, setAnalysisError] = React.useState(null);
      const [isAnalyzing, setIsAnalyzing] = React.useState(false);
      const [analysisStep, setAnalysisStep] = React.useState('input'); // Добавляем недостающее состояние
      const [selectedAnalysis, setSelectedAnalysis] = React.useState(null); // Добавляем состояние для выбранного анализа
      
      // Состояния для статуса Ollama
      const [ollamaStatus, setOllamaStatus] = React.useState({
        server_available: false,
        model_loaded: false,
        ready_for_work: false,
        status: 'unknown',
        message: 'Проверка статуса...',
        last_check: null,
        error: null
      });
      const [isCheckingOllama, setIsCheckingOllama] = React.useState(false);

      React.useEffect(() => { 
        console.log('🚀 SEO Link Recommender загружен');
        
        // Инициализируем Feather Icons
        if (window.feather) {
          window.feather.replace();
        }
        
        const newClientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        setClientId(newClientId);
        
        loadDomains();
        loadAnalysisHistory();
        connectWebSocket(newClientId);
        
        // Проверяем статус Ollama при загрузке
        checkOllamaStatus();
        
        // Автоматическая проверка статуса Ollama каждые 30 секунд
        const ollamaInterval = setInterval(checkOllamaStatus, 30000);
        
        return () => {
          if (websocket) {
            websocket.close();
          }
          clearInterval(ollamaInterval);
        };
      }, []);
      
      function connectWebSocket(clientId) {
        if (!clientId) return;
        
        setConnectionStatus('connecting');
        console.log('🔌 Подключение к WebSocket...', clientId);
        
        const ws = new WebSocket(`ws://localhost:8000/ws/${clientId}`);
        
        ws.onopen = () => {
          console.log('✅ WebSocket подключен');
          setConnectionStatus('connected');
          setWebsocket(ws);
          addLog('success', 'WebSocket соединение установлено');
          addNotification('success', 'Соединение установлено', 'WebSocket готов к работе');
        };
        
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
          } catch (err) {
            console.error('❌ Ошибка парсинга WebSocket сообщения:', err);
          }
        };
        
        ws.onclose = () => {
          console.log('🔌 WebSocket отключен');
          setConnectionStatus('disconnected');
          setWebsocket(null);
          addNotification('warning', 'Соединение потеряно', 'Переподключение через 3 секунды...');
          setTimeout(() => connectWebSocket(clientId), 3000);
        };
        
        ws.onerror = (error) => {
          console.error('❌ Ошибка WebSocket:', error);
          addLog('error', 'Ошибка WebSocket соединения');
          addNotification('error', 'Ошибка соединения', 'Проблема с WebSocket');
        };
      }
      
      function addNotification(type, title, message, duration = 5000) {
        const notification = {
          id: Date.now() + Math.random(),
          type,
          title,
          message,
          timestamp: new Date(),
          duration
        };
        
        setNotifications(prev => [notification, ...prev.slice(0, 9)]); // Максимум 10 уведомлений
        
        // Автоматически удаляем уведомление через указанное время
        if (duration > 0) {
          setTimeout(() => {
            removeNotification(notification.id);
          }, duration);
        }
      }
      
      function removeNotification(id) {
        setNotifications(prev => prev.filter(n => n.id !== id));
      }
      
      function handleWebSocketMessage(data) {
        console.log('📨 WebSocket сообщение:', data);
        
        switch (data.type) {
          case 'progress':
            // Минимизируем логи для производительности 
            if (process?.env?.NODE_ENV !== 'production') {
              addLog('info', `${data.step} (${data.current}/${data.total})`, data.details);
            }
            
            // Используем только setState - deferredValue предотвратит скачки скролла
            setAnalysisStats({
              step: data.step,
              current: data.current,
              total: data.total,
              percentage: data.percentage,
              details: data.details
            });
            
            // Прямое обновление только для критически важных элементов
            if (progressDetailsRef.current) {
              progressDetailsRef.current.textContent = data.details;
            }
            break;
            
          case 'ollama':
            if (data.info.status === 'starting') {
              addLog('info', '🤖 Запуск Ollama анализа', 
                `Модель: ${data.info.model}, Статей: ${data.info.articles_count}`);
              addNotification('info', 'Ollama запущена', `Анализ ${data.info.articles_count} статей`, 3000);
            } else if (data.info.status === 'response_preview') {
              // Оптимистично добавляем ответ в UI
              addOptimisticOllamaResponse({
                id: Date.now(),
                model: data.info.model,
                preview: data.info.preview,
                totalLength: data.info.total_length,
                timestamp: new Date(),
                type: 'preview'
              });
              
              // Минимизируем console.log для производительности
              if (process?.env?.NODE_ENV !== 'production') {
                addLog('info', '🧠 Ollama отвечает на русском', 
                  `Модель ${data.info.model} сгенерировала ${data.info.total_length} символов`);
              }
              
              // Обновляем детали прогресса без перерендера React
              if (progressDetailsRef.current) {
                progressDetailsRef.current.textContent = 
                  `🧠 Ollama думает на русском: ${data.info.total_length} символов сгенерировано...`;
              }
            } else if (data.info.status === 'completed') {
              addLog('success', '🤖 Ollama завершила анализ', 
                `Время: ${data.info.request_time}, Ответ: ${data.info.response_length} символов`);
              addNotification('success', 'Ollama завершена', `Анализ за ${data.info.request_time}`, 3000);
            }
            break;
            
          case 'error':
            addLog('error', data.message, data.details);
            setAnalysisError({
              message: data.message,
              details: data.details,
              timestamp: new Date()
            });
            addNotification('error', 'Ошибка анализа', data.message, 0); // Не автоудаляется
            setIsAnalyzing(false);
            break;
            
          case 'complete':
            if (data.delta_stats) {
              // Завершение индексации
              addLog('success', '✅ Индексация завершена успешно!', 
                `Новых: ${data.delta_stats.new_posts}, Обновлено: ${data.delta_stats.updated_posts}, Удалено: ${data.delta_stats.removed_posts}`);
              
              addNotification('success', 'Индексация завершена!', 
                `${data.posts_count} статей проиндексировано`, 3000);
            } else {
              // Завершение генерации рекомендаций
              addLog('success', '✅ Рекомендации созданы успешно!', 
                `Найдено ${data.recommendations_count} рекомендаций`);
              
              addNotification('success', 'Рекомендации готовы!', 
                `${data.recommendations_count} качественных рекомендаций`, 0);
            }
            
            setIsAnalyzing(false);
            break;
        }
      }
      
      function addLog(type, message, details = '') {
        const logEntry = {
          id: Date.now() + Math.random(),
          type,
          message,
          details,
          timestamp: new Date().toLocaleTimeString()
        };
        
        setAnalysisLogs(prev => [...prev, logEntry]);
        console.log(`📝 [${type.toUpperCase()}] ${message}`, details);
      }

      async function loadDomains() {
        try {
          const resp = await fetch('http://localhost:8000/api/v1/domains');
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          
          const data = await resp.json();
          setDomains(data);
          console.log('📥 Домены загружены:', data.length);
          
          // Отладочная информация
          data.forEach(domain => {
            console.log(`🔍 ДОМЕН ОТЛАДКА: ${domain.name}`, {
              total_posts: domain.total_posts,
              is_indexed: domain.is_indexed,
              id: domain.id
            });
          });
        } catch (err) {
          console.error('❌ Ошибка загрузки доменов:', err);
          setError(`Ошибка загрузки доменов: ${err.message}`);
          addNotification('error', 'Ошибка загрузки', 'Не удалось загрузить домены');
        }
      }
      
      async function loadAnalysisHistory() {
        try {
          const resp = await fetch('http://localhost:8000/api/v1/analysis_history');
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          
          const data = await resp.json();
          setAnalysisHistory(data);
          console.log('📥 История анализов загружена:', data.length);
        } catch (err) {
          console.error('❌ Ошибка загрузки истории:', err);
          setError(`Ошибка загрузки истории: ${err.message}`);
          addNotification('error', 'Ошибка загрузки', 'Не удалось загрузить историю анализов');
        }
      }
      
      async function checkOllamaStatus() {
        if (isCheckingOllama) return;
        
        setIsCheckingOllama(true);
        console.log('🔍 Проверка статуса Ollama...');
        
        try {
          const resp = await fetch('http://localhost:8000/api/v1/ollama_status');
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          
          const data = await resp.json();
          setOllamaStatus(data);
          
          console.log('📊 Статус Ollama обновлен:', data.status);
          
          // Добавляем уведомление только при изменении статуса
          if (data.status === 'ready' && ollamaStatus.status !== 'ready') {
            addNotification('success', 'Ollama готова!', data.message, 3000);
          } else if (data.status !== 'ready' && ollamaStatus.status === 'ready') {
            addNotification('warning', 'Ollama недоступна', data.message, 0);
          }
          
        } catch (err) {
          console.error('❌ Ошибка проверки Ollama:', err);
          setOllamaStatus(prev => ({
            ...prev,
            server_available: false,
            model_loaded: false,
            ready_for_work: false,
            status: 'error',
            message: `❌ Ошибка проверки: ${err.message}`,
            error: err.message,
            last_check: new Date().toISOString()
          }));
        } finally {
          setIsCheckingOllama(false);
        }
      }

      async function indexDomain(domainName) {
        if (!domainName.trim()) { 
          setError('Введите DNS имя сайта');
          return; 
        }
        
        if (!clientId || connectionStatus !== 'connected') {
          setError('WebSocket не подключен. Обновите страницу.');
          addNotification('error', 'Нет соединения', 'WebSocket не подключен');
          return;
        }
        
        setError('');
        setAnalysisError(null);
        setAnalysisLogs([]);
        setAnalysisStats({
          step: 'Инициализация',
          current: 0,
          total: 5,
          percentage: 0,
          details: 'Подготовка к умной индексации...'
        });
        setIsAnalyzing(true);
        setAnalysisStep('analyzing'); // Устанавливаем состояние анализа
        
        addLog('info', `🧠 Начинаю умную индексацию: ${domainName}`, 'Подключение к WordPress API...');
        addNotification('info', 'Индексация запущена', `Умная индексация домена ${domainName}`, 3000);
        
        try {
          const resp = await fetch('http://localhost:8000/api/v1/wp_index', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              domain: domainName,
              client_id: clientId
            })
          });
          
          if (!resp.ok) {
            const errorText = await resp.text();
            throw new Error(`HTTP ${resp.status}: ${errorText}`);
          }
          
          const data = await resp.json();
          addLog('success', 'Индексация завершена!', 
            `Новых: ${data.delta_stats.new_posts}, Обновлено: ${data.delta_stats.updated_posts}, Удалено: ${data.delta_stats.removed_posts}`);
          
          setIsAnalyzing(false);
          setAnalysisStep('input'); // Возвращаемся к состоянию ввода
          await loadDomains(); // Обновляем список доменов
          
        } catch (err) {
          console.error('❌ Ошибка индексации:', err);
          addLog('error', 'Критическая ошибка индексации', err.message);
          setAnalysisError({
            message: 'Критическая ошибка индексации',
            details: err.message,
            timestamp: new Date()
          });
          addNotification('error', 'Критическая ошибка', err.message, 0);
          setIsAnalyzing(false);
          setAnalysisStep('error'); // Устанавливаем состояние ошибки
        }
      }
      
      async function generateRecommendations(domainName) {
        console.log('🔍 ОТЛАДКА: generateRecommendations вызвана с доменом:', domainName);
        console.log('🔍 ОТЛАДКА: clientId:', clientId);
        console.log('🔍 ОТЛАДКА: connectionStatus:', connectionStatus);
        console.log('🔍 ОТЛАДКА: isAnalyzing:', isAnalyzing);
        
        if (!domainName) { 
          console.log('❌ ОТЛАДКА: Домен не выбран');
          setError('Домен не выбран');
          return; 
        }
        
        if (!clientId || connectionStatus !== 'connected') {
          console.log('❌ ОТЛАДКА: WebSocket проблема. clientId:', clientId, 'connectionStatus:', connectionStatus);
          setError('WebSocket не подключен. Обновите страницу.');
          addNotification('error', 'Нет соединения', 'WebSocket не подключен');
          return;
        }
        
        console.log('✅ ОТЛАДКА: Все проверки пройдены, начинаю генерацию...');
        
        setError('');
        setAnalysisError(null);
        setAnalysisLogs([]);
        setAnalysisStats({
          step: 'Инициализация',
          current: 0,
          total: 9,
          percentage: 0,
          details: 'Создание рекомендаций...'
        });
        setRecommendations([]);
        setIsAnalyzing(true);
        setShowRecommendations(true);
        setAnalysisStep('analyzing'); // Устанавливаем состояние анализа
        
        addLog('info', `🚀 Генерация рекомендаций для: ${domainName}`, 'Анализ проиндексированного контента...');
        addNotification('info', 'Генерация рекомендаций', `Создание рекомендаций для ${domainName}`, 3000);
        
        try {
          const resp = await fetch('http://localhost:8000/api/v1/wp_generate_recommendations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              domain: domainName,
              client_id: clientId
            })
          });
          
          if (!resp.ok) {
            const errorText = await resp.text();
            throw new Error(`HTTP ${resp.status}: ${errorText}`);
          }
          
          const data = await resp.json();
          setRecommendations(data.recommendations || []);
          setIsAnalyzing(false);
          setAnalysisStep('results'); // Переходим к результатам
          await loadDomains(); // Обновляем данные домена
          
        } catch (err) {
          console.error('❌ Ошибка генерации рекомендаций:', err);
          addLog('error', 'Критическая ошибка генерации', err.message);
          setAnalysisError({
            message: 'Критическая ошибка генерации',
            details: err.message,
            timestamp: new Date()
          });
          addNotification('error', 'Критическая ошибка', err.message, 0);
          setIsAnalyzing(false);
          setAnalysisStep('error'); // Устанавливаем состояние ошибки
        }
      }
      
      function resetAnalysis() {
        setAnalysisLogs([]);
        setAnalysisStats(null);
        setRecommendations([]);
        setAnalysisError(null);
        setIsAnalyzing(false);
        setShowRecommendations(false);
        setError('');
        setAnalysisStep('input'); // Возвращаемся к состоянию ввода
      }
      
      function retryAnalysis() {
        if (selectedDomain) {
          generateRecommendations(selectedDomain);
        } else if (domain) {
          indexDomain(domain);
        }
      }

      function AnalysisOverlay() {
        if (analysisStep !== 'analyzing') return null;
        
        return (
          <div className="analysis-overlay">
            <div className="analysis-window">
              <div className="text-center mb-4">
                <h2 className="hero-title" style={{fontSize: '2rem', marginBottom: '0.5rem', color: '#000000', fontWeight: '600'}}>
                  <i data-feather="cpu" className="icon-apple" style={{marginRight: '12px', color: '#007AFF'}}></i>
                  Кумулятивный анализ <span style={{color: '#007AFF', fontWeight: '700'}}>{domain}</span>
                </h2>
                <p style={{color: '#000000', fontSize: '1.1rem', fontWeight: '500'}}>
                  Накопление знаний и эволюция рекомендаций
                </p>
              </div>
              
              {analysisStats && (
                <div className={`stats-card ${analysisStats.shouldAnimate ? 'smooth-update' : ''}`} style={{
                  background: analysisError ? 
                    'linear-gradient(135deg, var(--apple-red) 0%, #ff6b6b 100%)' :
                    'linear-gradient(135deg, var(--apple-blue) 0%, var(--apple-blue-light) 100%)'
                }}>
                  <div className="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <div className="font-weight-bold" style={{fontSize: '1.25rem'}}>
                        {analysisError ? 'Ошибка анализа' : (deferredAnalysisStats ? deferredAnalysisStats.step : 'Подготовка...')}
                      </div>
                      <div style={{opacity: isProgressStale ? 0.7 : 0.8, transition: 'opacity 0.2s ease'}}>
                        {analysisError ? 
                          'Процесс прерван' :
                          (deferredAnalysisStats ? `${deferredAnalysisStats.current}/${deferredAnalysisStats.total} (${deferredAnalysisStats.percentage}%)` : '0/0 (0%)')
                        }
                      </div>
                    </div>
                    <div style={{fontSize: '2rem'}}>
                      {analysisError ? '❌' : 
                       (deferredAnalysisStats?.percentage === 100) ? '✅' : '⚙️'}
                    </div>
                  </div>
                  
                  <div className="progress-apple">
                    <div 
                      className="progress-bar" 
                      style={{
                        width: analysisError ? '100%' : (deferredAnalysisStats ? `${deferredAnalysisStats.percentage}%` : '0%'),
                        background: analysisError ? 
                          'linear-gradient(90deg, var(--apple-red), #ff6b6b)' :
                          'linear-gradient(90deg, var(--apple-blue), var(--apple-blue-light))',
                        opacity: isProgressStale ? 0.8 : 1,
                        transition: 'width 0.3s ease-out, opacity 0.2s ease'
                      }}
                    ></div>
                  </div>
                  
                  <div ref={progressDetailsRef} className="mt-2" style={{color: '#FFFFFF', fontSize: '0.95rem', fontWeight: '500'}}>
                    {analysisError ? analysisError.details : (deferredAnalysisStats ? deferredAnalysisStats.details : 'Ожидание...')}
                  </div>
                  
                  {/* Секция ответов Ollama */}
                  {optimisticOllamaResponses.length > 0 && (
                    <div className="mt-4" style={{background: 'rgba(255, 255, 255, 0.1)', borderRadius: '8px', padding: '16px'}}>
                      <h6 style={{color: '#FFFFFF', marginBottom: '12px', fontSize: '1rem'}}>
                        🧠 Ответы Ollama на русском языке
                      </h6>
                      {optimisticOllamaResponses.slice(-3).map((response, index) => (
                        <div key={response.id} style={{
                          background: 'rgba(255, 255, 255, 0.05)',
                          borderRadius: '6px',
                          padding: '12px',
                          marginBottom: '8px',
                          border: response.pending ? '1px dashed rgba(255, 255, 255, 0.3)' : 'none',
                          opacity: response.pending ? 0.8 : 1
                        }}>
                          <div style={{fontSize: '0.8rem', color: 'rgba(255, 255, 255, 0.7)', marginBottom: '4px'}}>
                            {response.timestamp.toLocaleTimeString()} • {response.model} • {response.totalLength} символов
                            {response.pending && ' • Обрабатывается...'}
                          </div>
                          <div style={{color: '#FFFFFF', fontSize: '0.9rem', lineHeight: '1.4'}}>
                            {response.preview}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
              
              {analysisError && (
                <div className="notification-apple notification-error mb-4">
                  <div className="d-flex justify-content-between align-items-start">
                    <div>
                      <div className="font-weight-semibold">{analysisError.message}</div>
                      <div className="mt-2" style={{fontSize: '0.9rem'}}>{analysisError.details}</div>
                      <div className="mt-2 text-muted" style={{fontSize: '0.8rem'}}>
                        Время ошибки: {analysisError.timestamp.toLocaleString()}
                      </div>
                    </div>
                  </div>
                  
                  <div className="d-flex gap-2 mt-3">
                    <button 
                      className="btn-apple btn-primary"
                      onClick={retryAnalysis}
                      disabled={isAnalyzing}
                    >
                      <i data-feather="refresh-cw" className="icon-apple"></i>
                      Повторить анализ
                    </button>
                    <button 
                      className="btn-apple btn-secondary"
                      onClick={resetAnalysis}
                    >
                      <i data-feather="arrow-left" className="icon-apple"></i>
                      Вернуться к вводу
                    </button>
                  </div>
                </div>
              )}
              
              <div className="log-container">
                <h5 className="font-weight-semibold mb-3">
                  <i data-feather="file-text" className="icon-apple" style={{marginRight: '8px'}}></i>
                  Логи анализа
                </h5>
                {analysisLogs.length === 0 ? (
                  <p className="text-muted">Ожидание логов...</p>
                ) : (
                  analysisLogs.map(log => (
                    <div key={log.id} className={`log-entry log-${log.type}`}>
                      <div className="font-weight-semibold">
                        [{log.timestamp}] {log.message}
                      </div>
                      {log.details && (
                        <div className="mt-1" style={{color: '#FFFFFF', fontSize: '0.9rem', fontWeight: '500'}}>
                          {log.details}
                        </div>
                      )}
                    </div>
                  ))
                )}
              </div>
              
              <div className="d-flex justify-content-between align-items-center mt-4">
                <span className={`tag-apple ${
                  connectionStatus === 'connected' ? 'tag-success' : 
                  connectionStatus === 'connecting' ? 'tag-warning' : 'tag-danger'
                }`}>
                  <i data-feather={
                    connectionStatus === 'connected' ? 'wifi' : 
                    connectionStatus === 'connecting' ? 'loader' : 'wifi-off'
                  } className="icon-apple"></i>
                  {connectionStatus === 'connected' ? 'Подключено' : 
                   connectionStatus === 'connecting' ? 'Подключение...' : 'Отключено'}
                </span>
                
                {!analysisError && (
                  <button 
                    className="btn-apple btn-secondary"
                    onClick={resetAnalysis}
                  >
                    <i data-feather="x" className="icon-apple"></i>
                    Прервать анализ
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      React.useEffect(() => {
        if (window.feather) {
          window.feather.replace();
        }
      });

      return (
        <div>
          <AnalysisOverlay />
          
          {/* Боковое меню */}
          <aside className="sidebar">
            <div className="sidebar-header">
              <h1 className="sidebar-title">SEO Link Recommender</h1>
              <p className="sidebar-subtitle">Умный анализ внутренних ссылок</p>
            </div>
            
            <ul className="sidebar-menu">
              <li className="sidebar-menu-item">
                <button 
                  className={`sidebar-menu-link ${currentView === 'domains' ? 'active' : ''}`}
                  onClick={() => setCurrentView('domains')}
                >
                  <i data-feather="globe" className="icon-apple"></i>
                  <span>Управление доменами</span>
                  <span className="sidebar-badge">{domains.length}</span>
                </button>
              </li>
              <li className="sidebar-menu-item">
                <button 
                  className={`sidebar-menu-link ${currentView === 'history' ? 'active' : ''}`}
                  onClick={() => setCurrentView('history')}
                >
                  <i data-feather="bar-chart" className="icon-apple"></i>
                  <span>История анализов</span>
                  <span className="sidebar-badge">{analysisHistory.length}</span>
                </button>
              </li>
              <li className="sidebar-menu-item">
                <button 
                  className={`sidebar-menu-link ${currentView === 'notifications' ? 'active' : ''}`}
                  onClick={() => setCurrentView('notifications')}
                  style={{position: 'relative'}}
                >
                  <i data-feather="bell" className="icon-apple"></i>
                  <span>Уведомления</span>
                  {notifications.filter(n => !n.read).length > 0 && (
                    <span style={{
                      position: 'absolute',
                      top: '8px',
                      right: '8px',
                      background: 'var(--apple-red)',
                      color: 'white',
                      borderRadius: '50%',
                      width: '16px',
                      height: '16px',
                      fontSize: '10px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontWeight: 'bold'
                    }}>
                      {notifications.filter(n => !n.read).length}
                    </span>
                  )}
                  <span className="sidebar-badge">{notifications.length}</span>
                </button>
              </li>
            </ul>
            
            {/* Статус соединения и Ollama */}
            <div style={{marginTop: '20px', padding: '12px', background: 'rgba(0, 0, 0, 0.05)', borderRadius: 'var(--border-radius)'}}>
              <div style={{display: 'flex', alignItems: 'center', gap: '8px', fontSize: '12px', marginBottom: '8px'}}>
                <i data-feather={
                  connectionStatus === 'connected' ? 'wifi' : 
                  connectionStatus === 'connecting' ? 'loader' : 'wifi-off'
                } style={{width: '16px', height: '16px'}}></i>
                <span style={{color: connectionStatus === 'connected' ? 'var(--apple-green)' : 'var(--apple-red)'}}>
                  WebSocket: {connectionStatus === 'connected' ? 'Подключено' : 
                   connectionStatus === 'connecting' ? 'Подключение...' : 'Отключено'}
                </span>
              </div>
              
              <div style={{display: 'flex', alignItems: 'center', gap: '8px', fontSize: '12px'}}>
                <i data-feather={
                  ollamaStatus.ready_for_work ? 'check-circle' :
                  ollamaStatus.server_available ? 'alert-circle' :
                  isCheckingOllama ? 'loader' : 'x-circle'
                } style={{
                  width: '16px', 
                  height: '16px',
                  animation: isCheckingOllama ? 'spin 1s linear infinite' : 'none'
                }}></i>
                <span style={{
                  color: ollamaStatus.ready_for_work ? 'var(--apple-green)' :
                         ollamaStatus.server_available ? 'var(--apple-orange)' : 'var(--apple-red)'
                }}>
                  Ollama: {
                    ollamaStatus.ready_for_work ? 'Готова' :
                    ollamaStatus.server_available ? 'Модель не загружена' :
                    isCheckingOllama ? 'Проверка...' : 'Недоступна'
                  }
                </span>
              </div>
              
              {ollamaStatus.suggested_command && (
                <div style={{marginTop: '8px', fontSize: '10px', color: 'var(--apple-gray)', fontFamily: 'monospace'}}>
                  Запустите: {ollamaStatus.suggested_command}
                </div>
              )}
            </div>
          </aside>
          
          {/* Основной контент */}
          <div className="main-content">
          
          <section style={{padding: '20px 40px', minHeight: '100vh'}}>
            <div style={{maxWidth: '1200px', margin: '0 auto'}}>
              
              {currentView === 'domains' && (
                <div>
                  <div className="text-center mb-5">
                    <h2 style={{fontSize: '2.5rem', fontWeight: '600', marginBottom: '0.5rem'}}>
                      <i data-feather="globe" className="icon-apple" style={{marginRight: '12px'}}></i>
                      Управление доменами
                    </h2>
                    <p style={{color: '#000000', fontSize: '1.1rem'}}>
                      Индексируйте домены и создавайте рекомендации
                    </p>
                  </div>

                  {/* Форма добавления нового домена */}
                  <div className="step-card active mb-5">
                    <h3 style={{fontSize: '1.5rem', fontWeight: '600', marginBottom: '1rem'}}>
                      <i data-feather="plus-circle" className="icon-apple" style={{marginRight: '8px', color: 'var(--apple-blue)'}}></i>
                      Добавить новый домен
                    </h3>
                    
                    <div className="mb-4">
                      <label className="font-weight-semibold mb-2" style={{display: 'block', fontSize: '1.1rem'}}>
                        DNS имя сайта
                      </label>
                      <input 
                        className="input-apple input-large" 
                        type="text"
                        placeholder="example.com (без https://)" 
                        value={domain} 
                        onChange={e => setDomain(e.target.value)}
                        onKeyPress={e => e.key === 'Enter' && indexDomain(domain)}
                      />
                      <p className="text-muted mt-2">
                        Введите только DNS имя (например: site.ru), без протокола и слэшей
                      </p>
                    </div>
                    
                    <div className="text-center">
                      <button 
                        className="btn-apple btn-primary btn-large"
                        onClick={() => indexDomain(domain)}
                        disabled={!domain.trim() || connectionStatus !== 'connected' || isAnalyzing || !ollamaStatus.ready_for_work}
                      >
                        <i data-feather="database" className="icon-apple"></i>
                        {isAnalyzing ? 'Индексация...' : 'Индексировать домен'}
                      </button>
                    </div>
                    
                    <div className="text-center mt-3">
                      <span className={`tag-apple ${
                        connectionStatus === 'connected' ? 'tag-success' : 
                        connectionStatus === 'connecting' ? 'tag-warning' : 'tag-danger'
                      }`}>
                        <i data-feather={
                          connectionStatus === 'connected' ? 'wifi' : 
                          connectionStatus === 'connecting' ? 'loader' : 'wifi-off'
                        } className="icon-apple"></i>
                        WebSocket: {connectionStatus === 'connected' ? 'Готов' : 
                                  connectionStatus === 'connecting' ? 'Подключение...' : 'Нет связи'}
                      </span>
                      
                      <span className={`tag-apple ${
                        ollamaStatus.ready_for_work ? 'tag-success' : 
                        ollamaStatus.server_available ? 'tag-warning' : 'tag-danger'
                      }`} style={{marginLeft: '8px'}}>
                        <i data-feather={
                          ollamaStatus.ready_for_work ? 'check-circle' :
                          ollamaStatus.server_available ? 'alert-circle' :
                          isCheckingOllama ? 'loader' : 'x-circle'
                        } className="icon-apple"></i>
                        Ollama: {
                          ollamaStatus.ready_for_work ? 'Готова' :
                          ollamaStatus.server_available ? 'Модель не загружена' :
                          isCheckingOllama ? 'Проверка...' : 'Недоступна'
                        }
                      </span>
                    </div>
                  </div>

                  {/* Список доменов */}
                  {domains.length === 0 ? (
                    <div className="notification-apple" style={{maxWidth: '600px', margin: '0 auto'}}>
                      <div className="text-center">
                        <div style={{fontSize: '3rem', marginBottom: '1rem'}}>🌐</div>
                        <div className="font-weight-semibold">Нет доменов для управления</div>
                        <div className="mt-1">Добавьте первый домен для индексации!</div>
                      </div>
                    </div>
                  ) : (
                    <div>
                      <h3 style={{fontSize: '1.5rem', fontWeight: '600', marginBottom: '1.5rem'}}>
                        Ваши домены ({domains.length})
                      </h3>
                      
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '24px'}}>
                        {domains.map(domainObj => (
                          <div key={domainObj.id} className="card-apple">
                            <div style={{padding: '24px'}}>
                              <div className="d-flex align-items-center gap-2 mb-3">
                                <i data-feather="globe" className="icon-apple" style={{color: 'var(--apple-blue)'}}></i>
                                <span className="font-weight-semibold" style={{fontSize: '1.2rem'}}>{domainObj.name}</span>
                                {domainObj.is_indexed && (
                                  <span className="tag-apple tag-success">
                                    <i data-feather="check" className="icon-apple"></i>
                                    Проиндексирован
                                  </span>
                                )}
                              </div>
                              
                              <div className="mb-3">
                                <div className="text-muted mb-2" style={{fontSize: '0.9rem'}}>
                                  Последнее обновление: {new Date(domainObj.updated_at).toLocaleString('ru-RU')}
                                </div>
                                
                                                              <div className="d-flex gap-2 flex-wrap">
                                <span className="tag-apple" style={{background: domainObj.is_indexed ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)', color: domainObj.is_indexed ? 'var(--apple-green)' : 'var(--apple-red)'}}>
                                  <i data-feather="file-text" className="icon-apple"></i>
                                  {domainObj.total_posts} статей {domainObj.is_indexed ? '✅' : '❌ не индексирован'}
                                </span>
                                <span className="tag-apple">
                                  <i data-feather="bar-chart" className="icon-apple"></i>
                                  {domainObj.total_analyses} анализов
                                </span>
                                {domainObj.latest_recommendations_count > 0 && (
                                  <span className="tag-apple tag-success">
                                    <i data-feather="link" className="icon-apple"></i>
                                    {domainObj.latest_recommendations_count} рекомендаций
                                  </span>
                                )}
                                {domainObj.cumulative_recommendations > 0 && (
                                  <span className="tag-apple" style={{background: 'rgba(52, 199, 89, 0.1)', color: 'var(--apple-green)'}}>
                                    <i data-feather="layers" className="icon-apple"></i>
                                    {domainObj.cumulative_recommendations} накопленных
                                  </span>
                                )}
                                {domainObj.thematic_clusters > 0 && (
                                  <span className="tag-apple" style={{background: 'rgba(0, 122, 255, 0.1)', color: 'var(--apple-blue)'}}>
                                    <i data-feather="hexagon" className="icon-apple"></i>
                                    {domainObj.thematic_clusters} кластеров
                                  </span>
                                )}
                                {domainObj.cumulative_insights > 0 && (
                                  <span className="tag-apple" style={{background: 'rgba(255, 149, 0, 0.1)', color: 'var(--apple-orange)'}}>
                                    <i data-feather="lightbulb" className="icon-apple"></i>
                                    {domainObj.cumulative_insights} инсайтов
                                  </span>
                                )}
                              </div>
                              
                              {/* Индикатор уровня интеллекта */}
                              {domainObj.intelligence_level > 0 && (
                                <div className="mt-3">
                                  <div style={{fontSize: '0.8rem', color: '#000000', marginBottom: '4px'}}>
                                    Уровень кумулятивного интеллекта
                                  </div>
                                  <div style={{
                                    background: '#f0f0f0',
                                    borderRadius: '4px',
                                    height: '6px',
                                    overflow: 'hidden'
                                  }}>
                                    <div style={{
                                      background: `linear-gradient(90deg, var(--apple-orange), var(--apple-green))`,
                                      height: '100%',
                                      width: `${domainObj.intelligence_level * 100}%`,
                                      transition: 'width 0.8s ease'
                                    }}></div>
                                  </div>
                                  <div style={{fontSize: '0.7rem', color: '#000000', marginTop: '2px'}}>
                                    {(domainObj.intelligence_level * 100).toFixed(1)}% развития
                                  </div>
                                </div>
                              )}
                              </div>
                              
                              {/* Рекомендации внутри карточки */}
                              {selectedDomain === domainObj.name && showRecommendations && recommendations.length > 0 && (
                                <div className="mb-4" style={{
                                  background: 'var(--apple-gray-light)',
                                  borderRadius: 'var(--border-radius)',
                                  padding: '20px',
                                  border: '2px solid var(--apple-blue)'
                                }}>
                                  <div className="d-flex justify-content-between align-items-center mb-3">
                                    <h4 style={{fontSize: '1.1rem', fontWeight: '600', margin: '0'}}>
                                      <i data-feather="link" className="icon-apple" style={{marginRight: '8px', color: 'var(--apple-green)'}}></i>
                                      Рекомендации ({recommendations.length})
                                    </h4>
                                    <button 
                                      className="btn-apple btn-secondary"
                                      onClick={() => {
                                        setShowRecommendations(false);
                                        setSelectedDomain(null);
                                        setRecommendations([]);
                                      }}
                                      style={{padding: '8px'}}
                                    >
                                      <i data-feather="x" className="icon-apple"></i>
                                    </button>
                                  </div>
                                  
                                  <div style={{display: 'grid', gap: '16px', maxHeight: '600px', overflowY: 'auto'}}>
                                    {recommendations.map((rec, i) => (
                                      <div key={i} style={{
                                        background: 'var(--apple-white)',
                                        borderRadius: '8px',
                                        padding: '16px',
                                        border: '1px solid #e5e5ea'
                                      }}>
                                        <div className="font-weight-semibold mb-2" style={{color: 'var(--apple-blue)', fontSize: '0.9rem'}}>
                                          Рекомендация #{i + 1}
                                        </div>
                                        
                                        <div className="mb-2">
                                          <div style={{fontSize: '0.8rem', color: '#000000', marginBottom: '4px'}}>Анкор:</div>
                                          <div style={{
                                            background: 'rgba(255, 149, 0, 0.1)',
                                            padding: '8px',
                                            borderRadius: '6px',
                                            fontSize: '0.9rem',
                                            fontWeight: '500'
                                          }}>
                                            {rec.anchor}
                                          </div>
                                        </div>
                                        
                                        <div className="mb-2">
                                          <div style={{fontSize: '0.8rem', color: '#000000', marginBottom: '4px'}}>От:</div>
                                          <div style={{fontSize: '0.8rem', wordBreak: 'break-all'}}>{rec.from}</div>
                                        </div>
                                        
                                        <div>
                                          <div style={{fontSize: '0.8rem', color: '#000000', marginBottom: '4px'}}>К:</div>
                                          <div style={{fontSize: '0.8rem', wordBreak: 'break-all'}}>{rec.to}</div>
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </div>
                            
                            <div style={{borderTop: '1px solid #f0f0f0', padding: '0'}}>
                              <div className="d-flex">
                                <button 
                                  className="btn-apple btn-secondary"
                                  style={{
                                    flex: 1,
                                    borderRadius: '0 0 0 var(--border-radius-large)',
                                    borderRight: '1px solid #f0f0f0'
                                  }}
                                  onClick={() => indexDomain(domainObj.name)}
                                  disabled={isAnalyzing}
                                >
                                  <i data-feather="refresh-cw" className="icon-apple"></i>
                                  Реиндексировать
                                </button>
                                <button 
                                  className="btn-apple btn-primary"
                                  style={{
                                    flex: 1,
                                    borderRadius: '0 0 var(--border-radius-large) 0',
                                    opacity: (!domainObj.is_indexed || isAnalyzing) ? 0.5 : 1
                                  }}
                                  onClick={() => {
                                    console.log('🔍 ОТЛАДКА: Нажата кнопка для домена:', domainObj.name);
                                    console.log('🔍 ОТЛАДКА: domainObj.is_indexed:', domainObj.is_indexed);
                                    console.log('🔍 ОТЛАДКА: isAnalyzing:', isAnalyzing);
                                    console.log('🔍 ОТЛАДКА: Кнопка заблокирована?', !domainObj.is_indexed || isAnalyzing);
                                    setSelectedDomain(domainObj.name);
                                    generateRecommendations(domainObj.name);
                                  }}
                                  disabled={!domainObj.is_indexed || isAnalyzing}
                                  title={!domainObj.is_indexed ? 'Сначала проиндексируйте домен' : isAnalyzing ? 'Дождитесь завершения текущего анализа' : 'Создать рекомендации'}
                                >
                                  <i data-feather="zap" className="icon-apple"></i>
                                  Создать рекомендации {!domainObj.is_indexed && '(❌ не индексирован)'}
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {error && (
                    <div className="notification-apple notification-error mt-4">
                      <div className="d-flex justify-content-between align-items-center">
                        <div>
                          <div className="font-weight-semibold">Ошибка:</div>
                          <div className="mt-1">{error}</div>
                        </div>
                        <button 
                          className="btn-apple btn-secondary"
                          onClick={() => setError('')}
                          style={{padding: '8px'}}
                        >
                          <i data-feather="x" className="icon-apple"></i>
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              {currentView === 'history' && (
                <div>
                  <div className="text-center mb-5">
                    <h2 style={{fontSize: '2.5rem', fontWeight: '600', marginBottom: '0.5rem'}}>
                      <i data-feather="bar-chart" className="icon-apple" style={{marginRight: '12px'}}></i>
                      История анализов
                    </h2>
                  </div>
                  
                  {analysisHistory.length === 0 ? (
                    <div className="notification-apple" style={{maxWidth: '600px', margin: '0 auto'}}>
                      <div className="text-center">
                        <div style={{fontSize: '3rem', marginBottom: '1rem'}}>📊</div>
                        <div className="font-weight-semibold">История анализов пуста</div>
                        <div className="mt-1">Проведите первый анализ WordPress сайта!</div>
                      </div>
                    </div>
                  ) : (
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '24px'}}>
                      {analysisHistory.map(analysis => (
                        <div key={analysis.id} className="card-apple">
                          <div style={{padding: '24px 24px 16px'}}>
                            <div className="d-flex align-items-center gap-2 mb-3">
                              <i data-feather="globe" className="icon-apple"></i>
                              <span className="font-weight-semibold">{analysis.domain}</span>
                            </div>
                            
                            <div className="text-muted mb-3" style={{fontSize: '0.85rem'}}>
                              {new Date(analysis.created_at).toLocaleString('ru-RU')}
                            </div>
                            
                            <p style={{lineHeight: '1.5', marginBottom: '1rem'}}>
                              {analysis.summary}
                            </p>
                            
                            <div className="d-flex gap-2 mb-3">
                              <span className="tag-apple">
                                <i data-feather="file-text" className="icon-apple"></i>
                                {analysis.posts_count} статей
                              </span>
                              <span className="tag-apple tag-success">
                                <i data-feather="link" className="icon-apple"></i>
                                {analysis.recommendations_count} ссылок
                              </span>
                            </div>
                          </div>
                          
                          <div style={{borderTop: '1px solid #f0f0f0', padding: '0'}}>
                            <button 
                              className="btn-apple btn-primary"
                              style={{width: '100%', borderRadius: '0 0 var(--border-radius-large) var(--border-radius-large)'}}
                              onClick={() => {
                                setSelectedAnalysis(analysis);
                                setRecommendations(analysis.recommendations);
                                setAnalysisStep('results');
                                setDomain(analysis.domain);
                                setCurrentView('main');
                              }}
                            >
                              <i data-feather="eye" className="icon-apple"></i>
                              Посмотреть результаты
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
              
              {currentView === 'notifications' && (
                <div>
                  <div className="text-center mb-5">
                    <h2 style={{fontSize: '2.5rem', fontWeight: '600', marginBottom: '0.5rem', color: '#000000'}}>
                      <i data-feather="bell" className="icon-apple" style={{marginRight: '12px'}}></i>
                      Уведомления
                    </h2>
                    <p style={{color: '#000000', fontSize: '1.1rem'}}>
                      События системы и результаты анализов
                    </p>
                  </div>
                  
                  <div className="d-flex justify-content-between align-items-center mb-4">
                    <div style={{display: 'flex', gap: '12px', alignItems: 'center'}}>
                      <span style={{color: '#000000', fontWeight: '500'}}>
                        Всего уведомлений: {notifications.length}
                      </span>
                      {notifications.filter(n => !n.read).length > 0 && (
                        <span className="tag-apple" style={{background: 'var(--apple-red)', color: 'white'}}>
                          <i data-feather="alert-circle" className="icon-apple"></i>
                          {notifications.filter(n => !n.read).length} непрочитанных
                        </span>
                      )}
                    </div>
                    <button 
                      className="btn-apple btn-secondary"
                      onClick={() => setNotifications([])}
                      disabled={notifications.length === 0}
                    >
                      <i data-feather="trash-2" className="icon-apple"></i>
                      Очистить все
                    </button>
                  </div>
                  
                  {notifications.length === 0 ? (
                    <div className="notification-apple" style={{maxWidth: '600px', margin: '0 auto'}}>
                      <div className="text-center">
                        <div style={{fontSize: '3rem', marginBottom: '1rem'}}>🔔</div>
                        <div className="font-weight-semibold" style={{color: '#000000'}}>Нет уведомлений</div>
                        <div className="mt-1" style={{color: '#000000'}}>Здесь будут отображаться события системы и результаты анализов</div>
                      </div>
                    </div>
                  ) : (
                    <div style={{display: 'grid', gap: '16px'}}>
                      {notifications.map(notification => (
                        <div 
                          key={notification.id}
                          className="card-apple"
                          style={{
                            borderLeft: `4px solid ${
                              notification.type === 'success' ? 'var(--apple-green)' :
                              notification.type === 'error' ? 'var(--apple-red)' :
                              notification.type === 'warning' ? 'var(--apple-orange)' : 'var(--apple-blue)'
                            }`,
                            opacity: notification.read ? 0.7 : 1
                          }}
                        >
                          <div style={{padding: '20px'}}>
                            <div className="d-flex justify-content-between align-items-start">
                              <div style={{flex: 1}}>
                                <div className="d-flex align-items-center gap-2 mb-2">
                                  <i data-feather={
                                    notification.type === 'success' ? 'check-circle' :
                                    notification.type === 'error' ? 'x-circle' :
                                    notification.type === 'warning' ? 'alert-triangle' : 'info'
                                  } style={{
                                    width: '18px', 
                                    height: '18px',
                                    color: notification.type === 'success' ? 'var(--apple-green)' :
                                           notification.type === 'error' ? 'var(--apple-red)' :
                                           notification.type === 'warning' ? 'var(--apple-orange)' : 'var(--apple-blue)'
                                  }}></i>
                                  <span className="font-weight-semibold" style={{fontSize: '1.1rem', color: '#000000'}}>
                                    {notification.title}
                                  </span>
                                  {!notification.read && (
                                    <span style={{
                                      background: 'var(--apple-red)',
                                      color: 'white',
                                      borderRadius: '50%',
                                      width: '8px',
                                      height: '8px',
                                      display: 'inline-block'
                                    }}></span>
                                  )}
                                </div>
                                
                                <div style={{fontSize: '1rem', color: '#000000', marginBottom: '8px', lineHeight: '1.5'}}>
                                  {notification.message}
                                </div>
                                
                                <div style={{fontSize: '0.85rem', color: '#3A3A3A'}}>
                                  {notification.timestamp.toLocaleString('ru-RU')}
                                </div>
                              </div>
                              
                              <button 
                                onClick={() => removeNotification(notification.id)}
                                className="btn-apple btn-secondary"
                                style={{padding: '8px', marginLeft: '12px'}}
                                title="Удалить уведомление"
                              >
                                <i data-feather="x" style={{width: '16px', height: '16px'}}></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
          </section>
          </div> {/* Закрываем main-content */}
        </div>
      );
    }

    console.log('🎯 Запускаю Apple-стиль React приложение...');
    ReactDOM.createRoot(document.getElementById('app')).render(<App />);
  </script>
</body>
</html>
